# Test configuration for CNC machine functionality
# This config demonstrates all the new CNC features

[mcu]
serial: /tmp/pseudoserial

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 1000
max_z_velocity: 10
max_z_accel: 100

[stepper_x]
step_pin: PF0
dir_pin: PF1
enable_pin: !PD7
microsteps: 16
rotation_distance: 40
endstop_pin: ^PE5
position_endstop: 0
position_max: 200
homing_speed: 50

[stepper_y]
step_pin: PF6
dir_pin: PF7
enable_pin: !PF2
microsteps: 16
rotation_distance: 40
endstop_pin: ^PJ1
position_endstop: 0
position_max: 200
homing_speed: 50

[stepper_z]
step_pin: PL3
dir_pin: PL1
enable_pin: !PK0
microsteps: 16
rotation_distance: 8
endstop_pin: ^PD3
position_endstop: 0.5
position_max: 200
homing_speed: 5

# CNC Spindle Configuration
[spindle]
enable_pin: PH6          # Relay or SSR to enable spindle
direction_pin: PB4       # Direction control (CW/CCW)
pwm_pin: PH4            # PWM for speed control
cycle_time: 0.001       # 1kHz PWM frequency
hardware_pwm: False
min_rpm: 100
max_rpm: 24000
min_power: 0.1
max_power: 1.0

# CNC Coolant Configuration
[coolant]
mist_pin: PH5          # Mist coolant control
flood_pin: PH3         # Flood coolant control

# Tool Change Configuration
[tool_change]
max_tool: 10
tool_change_macro: TOOL_CHANGE_CUSTOM
park_x: 0
park_y: 0
park_z: 25

# CNC Probing Configuration
[cnc_probing]
probe_pin: ^PD2        # Touch probe input
speed: 5
samples: 3
sample_retract_dist: 2.0
samples_tolerance: 0.05

# Work Coordinate Systems
[work_coordinate_systems]

# Feed Hold and Pause
[feed_hold]
feed_hold_pin: ^PE4    # External feed hold button
retract_length: 1.0
retract_speed: 50
lift_z: 5.0
move_speed: 100

# Canned Drilling Cycles
[canned_cycles]
default_feed_rate: 150
default_rapid_rate: 1000
default_dwell_time: 0.5

# Handwheel/Jog Wheel
[handwheel]
encoder_pin_a: ^PJ0
encoder_pin_b: ^PJ1
axis_x_pin: ^PL0
axis_y_pin: ^PL1
axis_z_pin: ^PL2
multiplier_0_pin: ^PL4    # 0.001mm
multiplier_1_pin: ^PL5    # 0.01mm
multiplier_2_pin: ^PL6    # 0.1mm
multiplier_3_pin: ^PL7    # 1.0mm
encoder_resolution: 100
max_velocity: 25
default_step: 0.1

# Basic macro for tool changes
[gcode_macro TOOL_CHANGE_CUSTOM]
gcode:
    {% set OLD_TOOL = params.OLD_TOOL|default(0)|int %}
    {% set NEW_TOOL = params.NEW_TOOL|default(0)|int %}
    
    # Custom tool change sequence
    G0 Z25          # Lift to safe height
    G0 X0 Y0        # Move to tool change position
    
    # Here you would add specific tool change logic
    # such as activating a tool changer, waiting for manual change, etc.
    
    M117 Change from T{OLD_TOOL} to T{NEW_TOOL}
    M0 P3           # Pause for 3 seconds

# Sample CNC operation macro
[gcode_macro CNC_START]
gcode:
    G90             # Absolute positioning
    G54             # Select work coordinate system 1
    G28             # Home all axes
    M9              # Coolant off
    M5              # Spindle off
    M117 CNC Ready

[gcode_macro CNC_END]
gcode:
    M5              # Spindle off
    M9              # Coolant off
    G0 Z25          # Lift to safe height
    G0 X0 Y0        # Return to origin
    M117 CNC Complete