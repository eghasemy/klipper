# Example configurations for all supported Modbus VFD protocols
# This file demonstrates how to configure various VFD spindles
# Copy the relevant section to your printer.cfg and modify as needed

# ==============================================================================
# MODBUS RTU CONFIGURATION (Required for all VFD types)
# ==============================================================================

[modbus]
device: /dev/ttyUSB0      # USB to RS485 adapter device
baudrate: 9600            # Baud rate (check VFD manual)
bytesize: 8               # Data bits
parity: N                 # Parity (N=None, E=Even, O=Odd)
stopbits: 1               # Stop bits
timeout: 1.0              # Communication timeout
slave_id: 1               # VFD Modbus slave address
retries: 3                # Number of retries on failure
retry_delay: 0.1          # Delay between retries

# ==============================================================================
# GENERIC MODBUS VFD (Basic support for standard Modbus VFDs)
# ==============================================================================

[modbus_spindle]
protocol: generic
min_rpm: 100
max_rpm: 24000
speed_register: 0x2000    # Frequency/speed register
control_register: 0x2001  # Control register  
status_register: 0x3000   # Status register (optional)
frequency_register: 0x3001 # Current frequency register (optional)
status_interval: 1.0      # Status polling interval

# ==============================================================================
# HUANYANG VFD (Most common Chinese VFD)
# ==============================================================================

[huanyang_spindle]
# Uses dedicated Huanyang implementation with proper frequency scaling
min_rpm: 100
max_rpm: 24000
speed_register: 0x1000    # Frequency register
control_register: 0x1001  # Control register
status_register: 0x2000   # Status register
frequency_register: 0x2001 # Current frequency register
rated_frequency: 50.0     # Rated motor frequency (Hz)
max_frequency: 100.0      # Maximum VFD frequency (Hz)
status_interval: 1.0

# Alternative using modbus_spindle with Huanyang protocol
[modbus_spindle huanyang_alt]
protocol: huanyang
min_rpm: 100
max_rpm: 24000
speed_register: 0x1000
control_register: 0x1001
status_register: 0x2000
frequency_register: 0x2001

# ==============================================================================
# H100 SERIES VFD
# ==============================================================================

[modbus_spindle h100]
protocol: h100
min_rpm: 100
max_rpm: 24000
speed_register: 0x0201    # PD-01 frequency register
control_register: 0x0049  # Control coils (0x49=CW, 0x4A=CCW, 0x4B=Stop)
status_register: 0x0005   # PD-05 max frequency
frequency_register: 0x0000 # Output frequency
status_interval: 1.0

# ==============================================================================
# H2A SERIES VFD
# ==============================================================================

[vfd_h2a]
# Uses dedicated H2A implementation with percentage-based speed control
min_rpm: 1000
max_rpm: 24000
speed_register: 0x1000    # Speed in percentage (0-10000 = 0-100%)
control_register: 0x2000  # Control register
status_register: 0xB005   # Max RPM register  
frequency_register: 0x700C # Current speed register
status_interval: 1.0

# ==============================================================================
# DANFOSS VLT2800 SERIES VFD
# ==============================================================================

[vfd_danfoss_vlt2800]
# Uses dedicated Danfoss implementation with complex control word
min_rpm: 100
max_rpm: 24000
speed_register: 0x0000    # Control coil start
control_register: 0x0000  # Control coil start
status_register: 0x0020   # Status coil start  
frequency_register: 0x143B # Current frequency register
max_frequency: 400.0      # Maximum VFD frequency (Hz)
status_interval: 1.0

# ==============================================================================
# SIEMENS V20 SERIES VFD
# ==============================================================================

[vfd_siemens_v20]
# Uses dedicated Siemens V20 implementation with scaled frequency
min_rpm: 100
max_rpm: 24000
speed_register: 0x0064    # HSW - Speed setpoint
control_register: 0x0063  # STW1 - Control word
status_register: 0x006D   # ZSW - Status word
frequency_register: 0x006E # HIW - Actual speed
motor_poles: 2            # Motor pole count
motor_phases: 3           # Motor phase count  
max_frequency: 400.0      # Maximum VFD frequency (Hz)
min_frequency: 0.0        # Minimum VFD frequency (Hz)
status_interval: 1.0

# ==============================================================================
# YL620 SERIES VFD
# ==============================================================================

[vfd_yl620]
# Uses dedicated YL620 implementation with deciHz frequency format
min_rpm: 600              # Will be read from VFD
max_rpm: 24000            # Will be read from VFD
speed_register: 0x2001    # Frequency command (x0.1Hz)
control_register: 0x2000  # Command register
status_register: 0x0308   # Frequency lower limit
frequency_register: 0x200B # Output frequency
max_freq_register: 0x0000 # Main frequency (P00.00)
status_interval: 1.0

# ==============================================================================
# NOWFOREVER SERIES VFD
# ==============================================================================

[vfd_nowforever]
# Uses dedicated NowForever implementation with Hz*100 format
min_rpm: 600              # Will be read from VFD
max_rpm: 24000            # Will be read from VFD
speed_register: 0x0901    # Speed in Hz*100
control_register: 0x0900  # Control register
status_register: 0x0007   # Max/min speed register
frequency_register: 0x0502 # Current frequency
fault_register: 0x0300    # Current fault register
status_interval: 1.0

# ==============================================================================
# USAGE EXAMPLES
# ==============================================================================

# Basic spindle operation:
# M3 S12000        ; Start spindle clockwise at 12000 RPM
# M4 S8000         ; Start spindle counter-clockwise at 8000 RPM  
# M5               ; Stop spindle

# Spindle with coolant:
# M3 S15000        ; Start spindle
# M8               ; Turn on flood coolant
# ; ... machining operations ...
# M5               ; Stop spindle
# M9               ; Turn off all coolant

# VFD-specific G-code commands are automatically registered:
# M3 - Spindle on clockwise
# M4 - Spindle on counter-clockwise
# M5 - Spindle off

# ==============================================================================
# TROUBLESHOOTING
# ==============================================================================

# 1. Check wiring:
#    - Ensure proper RS485 A/B wiring
#    - Use twisted pair cable for long runs
#    - Add 120Î© termination resistors if needed

# 2. Check VFD configuration:
#    - Set VFD to Modbus RTU mode
#    - Configure correct slave address
#    - Set appropriate baud rate and parity
#    - Enable remote control mode

# 3. Test communication:
#    - Start with slow baud rate (9600)
#    - Check Klipper logs for communication errors
#    - Verify register addresses in VFD manual

# 4. Common issues:
#    - Wrong slave_id: Check VFD address setting
#    - Timeout errors: Increase timeout value
#    - CRC errors: Check wiring and termination
#    - No response: Verify VFD is in Modbus mode

# ==============================================================================
# VFD SETUP REQUIREMENTS
# ==============================================================================

# Each VFD type requires specific parameter settings:

# Huanyang VFD:
# - PD163: Communication address (set to slave_id)
# - PD164: Baud rate (9600, 19200, etc.)
# - PD165: Communication protocol (1=Modbus RTU)

# H100 VFD:
# - Command source: RS485
# - Protocol: Modbus RTU
# - Address and baud rate as configured

# H2A VFD:
# - Control mode: Modbus
# - Communication parameters to match config

# Danfoss VLT2800:
# - Parameter 8-30: Protocol = FC Modbus RTU
# - Parameter 8-31: Address = slave_id
# - Parameter 8-32: Baud rate

# Siemens V20:
# - P0700[0]: Command source = 5 (RS485)
# - P1000[0]: Frequency setpoint = 5 (RS485)
# - P2023[0]: Protocol = 2 (Modbus RTU)
# - P2010[0]: Baud rate
# - P2021[0]: Modbus address

# YL620 VFD:
# - P00.01: Command source = 3
# - P03.00: RS485 Baud rate
# - P03.01: RS485 address
# - P03.02: RS485 protocol = 2

# NowForever VFD:
# - Set to Modbus RTU mode
# - Configure address and baud rate
# - Enable remote control