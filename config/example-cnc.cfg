# CNC Machine Configuration for Klipper
# Complete example demonstrating all CNC features

# ===== BASIC MACHINE CONFIGURATION =====

[mcu]
serial: /dev/ttyUSB0
baud: 250000

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 1000
max_z_velocity: 25
max_z_accel: 300

# ===== STEPPER MOTOR CONFIGURATION =====

[stepper_x]
step_pin: ar54
dir_pin: ar55
enable_pin: !ar38
microsteps: 16
rotation_distance: 40        # For 20-tooth GT2 pulley
endstop_pin: ^ar3
position_endstop: 0
position_max: 400
homing_speed: 50

[stepper_y]
step_pin: ar60
dir_pin: ar61
enable_pin: !ar56
microsteps: 16
rotation_distance: 40
endstop_pin: ^ar14
position_endstop: 0
position_max: 300
homing_speed: 50

[stepper_z]
step_pin: ar46
dir_pin: ar48
enable_pin: !ar62
microsteps: 16
rotation_distance: 8         # For 8mm lead screw
endstop_pin: ^ar18
position_endstop: 0.5
position_max: 100
position_min: -2.0          # Allow below bed for probing
homing_speed: 5

# ===== CNC SPINDLE CONFIGURATION =====

[spindle]
# Enable pin for spindle relay/contactor
enable_pin: ar8             # Connect to relay coil or SSR input

# Direction pin for CW/CCW control (optional)
direction_pin: ar9          # High = CW, Low = CCW (adjust with ! if needed)

# PWM pin for speed control (connect to VFD analog input)
pwm_pin: ar10               # Connect to VFD 0-10V or 4-20mA input via DAC
cycle_time: 0.001           # 1kHz PWM for smooth VFD control
hardware_pwm: False         # Use software PWM

# Speed mapping
min_rpm: 100                # Minimum spindle speed
max_rpm: 24000             # Maximum spindle speed
min_power: 0.1             # Minimum PWM duty (10%)
max_power: 1.0             # Maximum PWM duty (100%)

# ===== COOLANT CONTROL =====

[coolant]
# Mist coolant (air/oil mist system)
mist_pin: ar11             # Connect to mist coolant relay/solenoid

# Flood coolant (liquid coolant pump)
flood_pin: ar12            # Connect to flood coolant relay/pump

# ===== TOOL CHANGE SYSTEM =====

[tool_change]
max_tool: 20               # Maximum tool number (T0-T20)
tool_change_macro: TOOL_CHANGE_SEQUENCE
tool_pre_change_macro: TOOL_PRE_CHANGE
tool_post_change_macro: TOOL_POST_CHANGE

# Parking position during tool change
park_x: 0                  # X position to park spindle
park_y: 0                  # Y position to park spindle  
park_z: 25                 # Z position to park spindle

# ===== CNC PROBING SYSTEM =====

[cnc_probing]
probe_pin: ^ar19           # Touch probe input (normally open)
speed: 5                   # Probing feed rate (mm/s)
lift_speed: 10            # Retract speed
samples: 3                # Number of probe samples
sample_retract_dist: 2.0  # Distance to retract between samples
samples_tolerance: 0.05   # Maximum deviation between samples

# ===== WORK COORDINATE SYSTEMS =====

[work_coordinate_systems]
# Enables G54-G59 work coordinate system support
# No additional configuration needed

# ===== FEED HOLD AND PAUSE CONTROL =====

[feed_hold]
feed_hold_pin: ^ar20       # External feed hold button (optional)
retract_length: 1.0        # Retract distance during pause
retract_speed: 50          # Retract speed
lift_z: 5.0               # Z lift during pause
move_speed: 100           # Resume move speed

# ===== CANNED DRILLING CYCLES =====

[canned_cycles]
default_feed_rate: 200     # Default drilling feed rate (mm/min)
default_rapid_rate: 1500   # Default rapid move rate (mm/min)
default_dwell_time: 0.5    # Default dwell time (seconds)

# ===== HANDWHEEL/JOG CONTROL =====

[handwheel]
# Quadrature encoder inputs
encoder_pin_a: ^ar21       # Encoder A phase
encoder_pin_b: ^ar22       # Encoder B phase
encoder_resolution: 100    # Pulses per revolution

# Axis selection inputs (only one should be active at a time)
axis_x_pin: ^ar23          # X axis selection
axis_y_pin: ^ar24          # Y axis selection
axis_z_pin: ^ar25          # Z axis selection

# Step multiplier selection (only one should be active at a time)
multiplier_0_pin: ^ar26    # 0.001mm step
multiplier_1_pin: ^ar27    # 0.01mm step
multiplier_2_pin: ^ar28    # 0.1mm step
multiplier_3_pin: ^ar29    # 1.0mm step

# Step multipliers (mm per encoder click)
step_multipliers: 0.001,0.01,0.1,1.0
max_velocity: 25           # Maximum jog velocity
default_step: 0.1          # Default step size

# ===== MULTI-AXIS SUPPORT (A/B ROTARY AXES) =====

[multi_axis]
# A axis (4th axis rotary)
a_step_pin: ar36
a_dir_pin: ar34
a_enable_pin: !ar30
a_microsteps: 16
a_rotation_distance: 360.0    # Degrees per full rotation
a_position_min: -999999       # Unlimited rotation
a_position_max: 999999
a_max_velocity: 45            # Degrees per second
a_max_accel: 300              # Degrees per second squared
a_endstop_pin: ^ar2           # Optional home switch
a_position_endstop: 0

# B axis (5th axis rotary) - optional
#b_step_pin: ar26
#b_dir_pin: ar28
#b_enable_pin: !ar24
#b_microsteps: 16
#b_rotation_distance: 360.0
#b_position_min: -180         # Limited range for tilting axis
#b_position_max: 180
#b_max_velocity: 30
#b_max_accel: 200

# Acceleration limiting per axis
accel_limited_axes: z,a       # Limit acceleration on Z and A axes
z_max_accel: 200              # Specific Z acceleration limit
a_max_accel: 150              # Specific A acceleration limit

# ===== MACROS FOR CNC OPERATION =====

[gcode_macro CNC_START]
description: Initialize CNC machine for operation
gcode:
    G90                       # Absolute positioning
    G94                       # Feed rate in mm/min
    G17                       # XY plane selection
    G54                       # Default work coordinate system
    G40                       # Cancel cutter compensation
    G49                       # Cancel tool length compensation
    G80                       # Cancel canned cycles
    G98                       # Return to initial Z in canned cycles
    
    # Safety checks
    M5                        # Ensure spindle is off
    M9                        # Ensure coolant is off
    
    # Home all axes
    G28                       # Home XYZ
    
    M117 CNC Ready for Operation

[gcode_macro CNC_END]
description: Safe shutdown sequence for CNC machine
gcode:
    # Stop all motion
    M0                        # Program stop
    
    # Turn off spindle and coolant
    M5                        # Spindle off
    M9                        # Coolant off
    
    # Move to safe position
    G53 G0 Z0                 # Move Z to machine zero
    G53 G0 X0 Y0              # Move XY to machine zero
    
    # Reset work coordinate system
    G54                       # Back to G54
    
    M117 CNC Operation Complete

[gcode_macro TOOL_CHANGE_SEQUENCE]
description: Main tool change sequence
gcode:
    {% set OLD_TOOL = params.OLD_TOOL|default(0)|int %}
    {% set NEW_TOOL = params.NEW_TOOL|default(0)|int %}
    
    M117 Changing from T{OLD_TOOL} to T{NEW_TOOL}
    
    # Move to tool change position
    G53 G0 Z0                 # Rapid to Z home
    G53 G0 X0 Y0             # Rapid to XY home
    
    # Manual tool change prompt
    M0 Install tool T{NEW_TOOL} and press resume
    
    # Tool length measurement (if probe available)
    #G38.2 Z-50 F100          # Probe for tool length
    #G53 G0 Z5                # Retract
    
    M117 Tool T{NEW_TOOL} Ready

[gcode_macro TOOL_PRE_CHANGE]
description: Pre-tool change operations
gcode:
    # Save current state
    SAVE_GCODE_STATE NAME=TOOL_CHANGE
    
    # Ensure spindle is stopped
    M5
    
    # Retract from work
    G91                       # Relative mode
    G0 Z5                     # Lift 5mm
    G90                       # Back to absolute

[gcode_macro TOOL_POST_CHANGE]
description: Post-tool change operations  
gcode:
    # Tool length compensation would go here
    # For now, just restore state
    RESTORE_GCODE_STATE NAME=TOOL_CHANGE

[gcode_macro PROBE_CORNER]
description: Probe corner for work coordinate setup
gcode:
    {% set AXIS = params.AXIS|default('XY')|upper %}
    {% set CORNER = params.CORNER|default('SW')|upper %}
    
    # Probe sequence for corner finding
    G38.2 X-10 F100          # Probe left edge
    G91 G0 X1 G90            # Back off 1mm
    G38.2 Y-10 F100          # Probe front edge  
    G91 G0 Y1 G90            # Back off 1mm
    
    # Set work coordinate
    G92 X0 Y0                # Set current position as corner
    
    M117 {CORNER} corner set

[gcode_macro SURFACE_PROBE]
description: Probe Z surface for work coordinate
gcode:
    G38.2 Z-10 F50           # Probe down to surface
    G91 G0 Z1 G90            # Back off 1mm
    G92 Z0                   # Set surface as Z zero
    M117 Surface Z set

# ===== SAFETY MACROS =====

[gcode_macro EMERGENCY_STOP]
description: Emergency stop all motion and spindle
gcode:
    M112                     # Emergency stop
    M5                       # Spindle off
    M9                       # Coolant off
    M117 EMERGENCY STOP

[gcode_macro SPINDLE_WARMUP]
description: Warm up spindle at low speed
gcode:
    {% set SPEED = params.SPEED|default(1000)|int %}
    {% set TIME = params.TIME|default(30)|int %}
    
    M3 S{SPEED}              # Start spindle
    G4 P{TIME}               # Wait
    M5                       # Stop spindle
    M117 Spindle warmup complete

# ===== STATUS REPORTING =====

[gcode_macro CNC_STATUS]
description: Report CNC machine status
gcode:
    M117 Reporting CNC Status
    
    # Query all systems
    WCS_INFO                 # Work coordinate systems
    MULTI_AXIS_STATUS        # Multi-axis info
    HANDWHEEL_STATUS         # Handwheel status
    
    # Current position in all coordinate systems
    {% for system in [54, 55, 56, 57, 58, 59] %}
        G{system}
        M114                 # Report position
    {% endfor %}
    
    G54                      # Back to default